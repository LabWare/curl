# .github/workflows/win32-release.yml
name: win32-release

on:
  workflow_dispatch:
  push:
    tags:
      - "curl-*"

jobs:
  build-win32:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -------------------------
      # vcpkg (Win32 static libs + static CRT)
      # -------------------------
      - name: Setup vcpkg
        shell: pwsh
        run: |
          git clone https://github.com/microsoft/vcpkg $env:RUNNER_TEMP\vcpkg
          & $env:RUNNER_TEMP\vcpkg\bootstrap-vcpkg.bat -disableMetrics

      # Force triplet selection and show what vcpkg thinks the settings are.
      - name: Install dependencies (Win32 static)
        shell: pwsh
        run: |
          $env:VCPKG_DEFAULT_TRIPLET = "x86-windows-static"
          $env:VCPKG_HOST_TRIPLET    = "x64-windows"
          $env:VCPKG_BUILD_TYPE      = "release"

          Write-Host "VCPKG_DEFAULT_TRIPLET=$env:VCPKG_DEFAULT_TRIPLET"
          Write-Host "VCPKG_HOST_TRIPLET=$env:VCPKG_HOST_TRIPLET"
          Write-Host "VCPKG_BUILD_TYPE=$env:VCPKG_BUILD_TYPE"

          $vcpkg = "$env:RUNNER_TEMP\vcpkg\vcpkg.exe"

          # Use an explicit --triplet and clean any previously installed triplets in this vcpkg clone
          & $vcpkg remove --outdated --recurse || $true

          & $vcpkg install `
            zlib brotli zstd nghttp2 icu libiconv libunistring libidn2 libpsl `
            --triplet x86-windows-static `
            --clean-after-build

      # -------------------------
      # A) libcurl.dll (Win32, Release, /MT, Schannel, full features)
      # -------------------------
      - name: Configure libcurl.dll
        run: >
          cmake -S . -B build-win32-shared
          -G "Visual Studio 17 2022"
          -A Win32
          -DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreaded
          -DCMAKE_TOOLCHAIN_FILE=${{ runner.temp }}\vcpkg\scripts\buildsystems\vcpkg.cmake
          -DVCPKG_TARGET_TRIPLET=x86-windows-static
          -DCMAKE_FIND_PACKAGE_PREFER_CONFIG=ON
          -DBUILD_SHARED_LIBS=ON
          -DBUILD_STATIC_LIBS=OFF
          -DBUILD_CURL_EXE=OFF
          -DBUILD_TESTING=OFF
          -DCURL_USE_SCHANNEL=ON
          -DCURL_USE_OPENSSL=OFF
          -DUSE_NGHTTP2=ON
          -DUSE_LIBIDN2=ON
          -DCURL_USE_LIBPSL=ON

      - name: Build libcurl.dll
        run: cmake --build build-win32-shared --config Release

      # -------------------------
      # B) curl.exe (Win32, Release, /MT, static libcurl; no libcurl.dll import)
      # -------------------------
      - name: Configure curl.exe static
        run: >
          cmake -S . -B build-win32-static
          -G "Visual Studio 17 2022"
          -A Win32
          -DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreaded
          -DCMAKE_TOOLCHAIN_FILE=${{ runner.temp }}\vcpkg\scripts\buildsystems\vcpkg.cmake
          -DVCPKG_TARGET_TRIPLET=x86-windows-static
          -DCMAKE_FIND_PACKAGE_PREFER_CONFIG=ON
          -DBUILD_SHARED_LIBS=OFF
          -DBUILD_STATIC_LIBS=ON
          -DBUILD_CURL_EXE=ON
          -DBUILD_STATIC_CURL=ON
          -DBUILD_TESTING=OFF
          -DCURL_USE_SCHANNEL=ON
          -DCURL_USE_OPENSSL=OFF
          -DUSE_NGHTTP2=ON
          -DUSE_LIBIDN2=ON
          -DCURL_USE_LIBPSL=ON

      - name: Build curl.exe
        run: cmake --build build-win32-static --config Release

      # -------------------------
      # C) Stage outputs
      # -------------------------
      - name: Stage outputs
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force dist\shared\bin | Out-Null
          New-Item -ItemType Directory -Force dist\static\bin | Out-Null

          Copy-Item build-win32-shared\lib\Release\libcurl.dll dist\shared\bin\
          Copy-Item build-win32-static\src\Release\curl.exe dist\static\bin\

      # -------------------------
      # D) Verify curl.exe does not import libcurl.dll
      # -------------------------
      - name: Verify curl.exe does not import libcurl.dll
        shell: pwsh
        run: |
          $exe = "dist\static\bin\curl.exe"
          $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          $vs = & $vswhere -latest -property installationPath
          $dumpbin = Get-ChildItem "$vs\VC\Tools\MSVC" -Recurse dumpbin.exe | Select-Object -First 1 -Expand FullName
          $imports = & $dumpbin /nologo /imports $exe
          if ($imports -match "libcurl\.dll") {
            Write-Error "curl.exe imports libcurl.dll"
          } else {
            Write-Host "OK: no libcurl.dll import"
          }

      # -------------------------
      # E) Verify binaries are 32-bit (x86)
      # -------------------------
      - name: Verify binaries are 32-bit (x86)
        shell: pwsh
        run: |
          $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          $vs = & $vswhere -latest -property installationPath
          $dumpbin = Get-ChildItem "$vs\VC\Tools\MSVC" -Recurse dumpbin.exe | Select-Object -First 1 -Expand FullName

          foreach ($f in @("dist\static\bin\curl.exe", "dist\shared\bin\libcurl.dll")) {
            $h = & $dumpbin /nologo /headers $f
            if ($h -notmatch "machine \\(x86\\)") {
              Write-Error "$f is not x86"
            } else {
              Write-Host "OK: $f is x86"
            }
          }

      # -------------------------
      # F) Show curl feature summary
      # -------------------------
      - name: Show curl -V
        shell: pwsh
        run: |
          dist\static\bin\curl.exe -V

      # -------------------------
      # G) Upload artifacts (Actions UI)
      # -------------------------
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: curl-win32-release
          path: dist
          retention-days: 30
