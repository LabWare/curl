# Copyright (C) Labware
#
# SPDX-License-Identifier: curl

name: win32-release

on:
  workflow_dispatch:
  push:
    tags:
      - "curl-*"

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-win32:
    name: 'Build Win32'
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          persist-credentials: false

      # -------------------------
      # vcpkg (Win32 static libs + static CRT)
      # -------------------------
      - name: Export GitHub Actions cache environment variables
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Setup vcpkg
        shell: pwsh
        run: |
          git clone https://github.com/microsoft/vcpkg $env:RUNNER_TEMP\vcpkg
          & $env:RUNNER_TEMP\vcpkg\bootstrap-vcpkg.bat -disableMetrics

      - name: Enable vcpkg binary cache
        env:
          VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"
        shell: pwsh
        run: |
          echo "VCPKG_BINARY_SOURCES=$env:VCPKG_BINARY_SOURCES" >> $env:GITHUB_ENV

      - name: Install dependencies (Win32 static)
        shell: pwsh
        run: |
          $vcpkg = "$env:RUNNER_TEMP\vcpkg\vcpkg.exe"
          & $vcpkg remove --outdated --recurse || $true
          & $vcpkg install `
            zlib brotli zstd nghttp2 icu libiconv libunistring libidn2 libpsl `
            --triplet x86-windows-static `
            --clean-after-build

      # -------------------------
      # Build libcurl.dll and curl.exe using build script
      # -------------------------
      - name: Build libcurl.dll and curl.exe
        shell: pwsh
        run: |
          ./build.ps1 -VcpkgRoot "$env:RUNNER_TEMP\vcpkg"

      - name: Stage and verify outputs
        shell: bash
        run: |
          mkdir -p dist/bin
          cp build-win32/lib/Release/libcurl.dll dist/bin/
          cp build-win32/src/Release/curl.exe dist/bin/

          # Verify curl.exe does not import libcurl.dll
          if dumpbin //nologo //imports dist/bin/curl.exe | grep -qi "libcurl\.dll"; then
            echo "ERROR: curl.exe imports libcurl.dll"; exit 1
          fi

          # Verify binaries are 32-bit (x86)
          dumpbin //nologo //headers dist/bin/curl.exe | grep "machine (x86)" || { echo "built files are not x86"; exit 1; }
          dumpbin //nologo //headers dist/bin/libcurl.dll | grep "machine (x86)" || { echo "built files are not x86"; exit 1; }

          # Show curl feature summary
          dist/bin/curl.exe -V

      - name: Upload artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: curl-win32-release
          path: dist
          retention-days: 30

      - name: Upload to GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          REF_NAME: ${{ github.ref_name }}
        run: |
          zip -j dist/bin/curl-win32-x86.zip dist/bin/curl.exe dist/bin/libcurl.dll
          gh release upload "$REF_NAME" \
            dist/bin/curl-win32-x86.zip \
            --clobber || \
          gh release create "$REF_NAME" \
            --title "$REF_NAME" \
            --notes "## Win32 (x86) builds" \
            dist/bin/curl-win32-x86.zip